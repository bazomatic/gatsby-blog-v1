---
layout: post
title: Building the pipeline
date: 2020-01-26
comments: false
published: true
---

## WILL IT BLEND?! ⚡️

tl;dr: yes, it will blend! that is, commits to master trigger a CodePipeline build and deploy to S3 🙌

## The Setup

Setting up the pipeline has been easier than I expected, further reinforcing that I was 100% in the right to procrastinate on doing this as long as I did. I already had the site building and manually deploying, so following Joshua Walsh's guide and using the template from Greeshma Sindhe's tutorial, I think it took like 15 minutes at most to get the actual pipeline to trigger a build on commit to master, mostly because AWS CodeBuild and CodePipeline do all the heavy lifting off of a single buildspec.yml file. Nice!

## Troubleshooting

The post-build (i.e. actual deployment to S3) failed on me because I'm pretty sure I failed to properly configure permissions to write to the S3 bucket. AWS docs indicated that despite the roles being autogenerated, and perhaps I missed it in the wizard, you still need to manually add the bucket arn and appropriate permissions to the role that CodeBuild will use. Which makes total sense.

Unfortunately I couldn't manually retry builds on my pipeline from the AWS console, so I pushed another commit to master, and... failure 🤦‍♂ Next attempt was to remove the s3 command in the buildspec.yml file since CodePipeline itself says it will drop the file into the bucket, and that actually solved the issue (i.e. the template, without edits, included unnecessary steps that I did not need to grant). The real lesson here was making sure I cleaned up the policy mod to the service account that codebuild was just unnecessarily given 😬

## Cleanup

After cleaning up IAM, I peeked into the deployed bucket and realized that while each build was deployed with previous versions of files being overwritten, existing bundle files with generated names from previous builds weren't being purged.

I settled on what is imo a risky solution: after a successful build of the website, delete the hosting bucket contents before deploying. If nothing else, should deployment fail after build I won't take an actual outage until the CDN caches update.

Would I do that on a project with an actual uptime requirement? Hell no. But this is faster 🏃

Incidentally, I needed to re-add the permissions for the CodeBuild role to be able to manipulate my deploy bucket since CodePipeline can only do what actions AWS pre-configured and give us to pass to it (like deploy to an S3 bucket). This isn't the worst workaround in the meantime, and at least deletion will only occur after a new build artifact is generated--which will, of course, always be flawless and prod ready. 👅

## Musings

- Gotta come up with a better way to handle the cleanup during build, but not a priority since this is a personal project.
- Should _probably_ make the styles not suck and actually finish my sidebar.
- Really, time to start focusing on something fun in my downtime, like indie game dev 🎮 but uh... sidebar first. probably.

## Shoutouts 🎉

🏫 Joshua Walsh's excellent tutorial [_'Gatsby on AWS, the right way'_](https://blog.joshwalsh.me/aws-gatsby/) for great insights into standing up CICD pipelines quickly on AWS, complete with a pre-prod environment

ℹ️ [Greeshma R. Sindhe](https://medium.com/@greeshu.renu/host-gatsby-js-site-on-amazon-s3-with-aws-codepipeline-675117686b9b) for a buildpsec.yml file template to pass into CodeBuild

🌐 [StackOverflow](https://stackoverflow.com/questions/55025290/aws-remove-files-in-s3-using-codebuild-in-codepipeline) as always; this was a handy answer to understand buildspec command syntax and purge bucket post-build
